<!DOCTYPE html>  <html> <head>   <title>mayaViewer.cpp</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               mayaViewer.cpp             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Consolidated documentation for the source code collectively known
as <code>mayaViewer</code>:</p>

<pre><code>     OpenSubdivShader.h/cpp
     OpenSubdivShaderOverride.h/cpp
     osdMeshData.h/cpp
     hbrUtil.h/cpp
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>OpenSubdivShader.h</h3>

<p>Class definition of custom MPxHwShaderNode for drawing OpenSubdiv patches.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">OpenSubdivShader</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MPxHwShaderNode</span> 
<span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <pre><code> Supports Viewport 2.0 rendering only.
 geometry/glGeometry, bind/glBind and unbind/glUnbind
 are not implemented at this time. 
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">public</span><span class="o">:</span>
    <span class="cm">/* ... Standard MPxHwShader methods and definitions ... */</span>

<span class="k">private</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h5>OSD attributes</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aLevel</span><span class="p">;</span>                  <span class="c1">// Subdivision level</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aTessFactor</span><span class="p">;</span>             <span class="c1">// GPU tesselation factor</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aScheme</span><span class="p">;</span>                 <span class="c1">// Subdivision scheme</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aAdaptive</span><span class="p">;</span>               <span class="c1">// Feature-adaptive toggle</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aWireframe</span><span class="p">;</span>              <span class="c1">// Wireframe display toggle</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aKernel</span><span class="p">;</span>                 <span class="c1">// Computation kernel</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aInterpolateBoundary</span><span class="p">;</span>    <span class="c1">// Boundary interpolation flag</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h5>Material attributes</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aDiffuse</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aAmbient</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aSpecular</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aShininess</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h5>Texture attributes</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aDiffuseMapFile</span><span class="p">;</span>         <span class="c1">// Texture filename</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aUVSet</span><span class="p">;</span>                  <span class="c1">// UV set (defaults to current UV set)</span>
    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aInterpolateUVBoundary</span><span class="p">;</span>  <span class="c1">// Boundary interpolation flag for face-varying data (UVs)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h5>Shader attribute</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">static</span> <span class="n">MObject</span> <span class="n">aShaderSource</span><span class="p">;</span>           <span class="c1">// Optional shader file</span>

<span class="k">private</span><span class="o">:</span>
    <span class="cm">/* ... private methods and member variables ... */</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>OpenSubdivShader.cpp</h3>

<p>Custom MPxHwShaderNode for drawing OpenSubdiv patches</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>OSD include initializing OpenSubdiv library version</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* Must be included before all other OSD includes */</span>
<span class="cp">#include &lt;version.h&gt;        </span>

<span class="cm">/* GLEW needs to be included before OSD and Maya headers */</span>
<span class="cp">#include &lt;GL/glew.h&gt;</span>

<span class="cm">/* ... System includes ... */</span>
<span class="cm">/* ... Maya includes ... */</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>dyu - difference between DrawContext and DrawRegistry?</code></p>

<p><code>I could take a stab but you can explain this in your sleep right?</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cp">#include &lt;osd/glDrawContext.h&gt;</span>
<span class="cp">#include &lt;osd/glDrawRegistry.h&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h5>Attribute declarations</h5>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* MObject OpenSubdivShader::... */</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h5>shaderSource attribute</h5>

<pre><code> A default shader is compiled into the plug-in.
 The shaderSource attribute offers the ability to modify or 
 replace the shader without having to recompile the plug-in.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">MObject</span> <span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">aShaderSource</span><span class="p">;</span>            <span class="c1">// Optional shader file</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">defaultShaderSource</span> <span class="o">=</span>
<span class="cp">#include &quot;shader.inc&quot;</span>
<span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <hr />

<h3>EffectDrawRegistry</h3>

<pre><code> An OpenSubdiv application builds its own draw registry in 
 order to define parameters needed for its shader.  In our 
 case we use the attributes from the OpenSubdivShader to set up 
 parameters and #define directives to pass through subdivision 
 options and to control draw style.  Client/application must
 specialize OsdGLDrawRegistry in order to provide an appearance
 for objects.  Built-in shaders to not contain lighting code.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Draw styles for EffectDrawRegistry</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">enum</span> <span class="n">Effect</span> 
<span class="p">{</span>
    <span class="n">kQuadFill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">kQuadLine</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">kTriFill</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">kTriLine</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">kPoint</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdPatchDescriptor</span><span class="p">,</span> <span class="n">Effect</span><span class="o">&gt;</span> <span class="n">EffectDesc</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h4>Override of OpenSubdiv::OsdGLDrawInstance</h4>

<p><code>dyu - when would someone need to add anything here?</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">struct</span> <span class="n">EffectDrawInstance</span> <span class="o">:</span> <span class="k">public</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawInstance</span> 
<span class="p">{</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h4>Override of OpenSubdiv::OsdGLDrawRegistry</h4>

<p>At the very least this class needs to define _CreateDrawConfig
and _CreateDrawInstance in order to define shader content.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">EffectDrawRegistry</span> <span class="o">:</span>
        <span class="k">public</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawRegistry</span><span class="o">&lt;</span><span class="n">EffectDesc</span><span class="p">,</span> <span class="n">EffectDrawInstance</span><span class="o">&gt;</span> 
<span class="p">{</span>

<span class="k">public</span><span class="o">:</span>
    <span class="n">EffectDrawRegistry</span><span class="p">()</span> <span class="o">:</span> <span class="n">_isAdaptive</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
                           <span class="n">_diffuseId</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                           <span class="n">_shaderSource</span><span class="p">(</span> <span class="n">defaultShaderSource</span> <span class="p">)</span>
            <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h5>Accessors</h5>

<pre><code> When setInternalValueInContext() gets triggered for certain 
 attributes it will set dirty flags causing the shaders to 
 be rebuilt.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="cm">/* isAdaptive */</span>
    <span class="kt">void</span> <span class="n">setIsAdaptive</span><span class="p">(</span> <span class="kt">bool</span> <span class="n">ad</span> <span class="p">)</span> <span class="p">{</span> <span class="n">resetIfChanged</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">_isAdaptive</span><span class="p">);</span> <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">getIsAdaptive</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_isAdaptive</span><span class="p">;</span> <span class="p">}</span>

    <span class="cm">/* diffuseId */</span>
    <span class="kt">void</span> <span class="n">setDiffuseId</span><span class="p">(</span> <span class="n">GLuint</span> <span class="n">dId</span> <span class="p">)</span> <span class="p">{</span> <span class="n">resetIfChanged</span><span class="p">(</span><span class="n">dId</span><span class="p">,</span> <span class="n">_diffuseId</span><span class="p">);</span> <span class="p">}</span>
    <span class="n">GLuint</span> <span class="n">getDiffuseId</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_diffuseId</span><span class="p">;</span> <span class="p">}</span>

    <span class="cm">/* shaderSource */</span>
    <span class="kt">void</span> <span class="n">setShaderSource</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">src</span> <span class="p">)</span> <span class="p">{</span> <span class="n">resetIfChanged</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">_shaderSource</span><span class="p">);</span> <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">getShaderSource</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_shaderSource</span><span class="p">;</span> <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h5>Build shader configuration</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">virtual</span> <span class="n">ConfigType</span> <span class="o">*</span> <span class="n">_CreateDrawConfig</span><span class="p">(</span><span class="n">DescType</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">desc</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h5>Compile and link the shader</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">virtual</span> <span class="n">InstanceType</span> <span class="o">*</span> <span class="n">_CreateDrawInstance</span><span class="p">(</span><span class="n">DescType</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">desc</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Clear the registry if a value has changed, triggering a rebuild</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="n">resetIfChanged</span><span class="p">(</span> <span class="n">T</span> <span class="n">newVal</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">curVal</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">newVal</span> <span class="o">!=</span> <span class="n">curVal</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">curVal</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span>
            <span class="n">Reset</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Parameters mirroring attributes that affect shader generation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">bool</span>        <span class="n">_isAdaptive</span><span class="p">;</span>
    <span class="n">GLuint</span>      <span class="n">_diffuseId</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_shaderSource</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h4>_CreateDrawConfig</h4>

<pre><code> Called by base registry when a draw configuration is requested.
 Returns a shader source configuration which consists of a 
 set of shader source code and compile-time configuration 
 defines.  These are cached by the effect registry for
 efficient re-use when rebuilding shaders.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">EffectDrawRegistry</span><span class="o">::</span><span class="n">ConfigType</span> <span class="o">*</span>
<span class="n">EffectDrawRegistry</span><span class="o">::</span><span class="n">_CreateDrawConfig</span><span class="p">(</span><span class="n">DescType</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">desc</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="n">Effect</span> <span class="n">effect</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">second</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Create base draw configuration</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">ConfigType</span> <span class="o">*</span> <span class="n">config</span> <span class="o">=</span> <span class="n">BaseRegistry</span><span class="o">::</span><span class="n">_CreateDrawConfig</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">kPerVertex</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Per-vertex descriptors are use for uniform refinement</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">effect</span> <span class="o">==</span> <span class="n">kQuadFill</span><span class="p">)</span> <span class="n">effect</span> <span class="o">=</span> <span class="n">kTriFill</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">effect</span> <span class="o">==</span> <span class="n">kQuadLine</span><span class="p">)</span> <span class="n">effect</span> <span class="o">=</span> <span class="n">kTriLine</span><span class="p">;</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;SMOOTH_NORMALS&quot;</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Configuration for adaptive refinement</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">config</span><span class="o">-&gt;</span><span class="n">vertexShader</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;#version 410</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">vertexShader</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">_shaderSource</span><span class="p">;</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">vertexShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;VERTEX_SHADER&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">config</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Enable feature-adaptive face-varying UV generation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">_isAdaptive</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;FVAR_ADAPTIVE&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Enable diffuse texture display if there is a valid texture map</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">_diffuseId</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;USE_DIFFUSE_MAP&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>NUM_ELEMENTS should be set to the same value that is specified 
for the "numElements" argument when creating OsdVertexBuffers, 
e.g. OsdGLVertexBuffer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">config</span><span class="o">-&gt;</span><span class="n">vertexShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;NUM_ELEMENTS&quot;</span><span class="p">,</span> <span class="s">&quot;3&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Initialize geometry shader</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;#version 410</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">_shaderSource</span><span class="p">;</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_SHADER&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Initialize fragment shader</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;#version 410</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">_shaderSource</span><span class="p">;</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;FRAGMENT_SHADER&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Set up directives according to draw style</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">switch</span> <span class="p">(</span><span class="n">effect</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">kQuadFill:</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_QUAD&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_FILL&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_QUAD&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_FILL&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">kQuadLine:</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_QUAD&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_LINE&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_QUAD&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_LINE&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">kTriFill:</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_TRI&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_FILL&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_TRI&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_FILL&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">kTriLine:</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_TRI&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_LINE&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_TRI&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;GEOMETRY_OUT_LINE&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">kPoint:</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_POINT&quot;</span><span class="p">);</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">AddDefine</span><span class="p">(</span><span class="s">&quot;PRIM_POINT&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">config</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Global GL buffer IDs and binding points</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">GLuint</span> <span class="n">g_transformUB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
       <span class="n">g_transformBinding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
       <span class="n">g_tessellationUB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
       <span class="n">g_tessellationBinding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
       <span class="n">g_lightingUB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
       <span class="n">g_lightingBinding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h4>compileShader</h4>

<pre><code> Common code for compiling each of the shader types
 (vertex, geometry, fragment, etc)
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">static</span> <span class="n">GLuint</span>
<span class="n">compileShader</span><span class="p">(</span><span class="n">GLenum</span> <span class="n">shaderType</span><span class="p">,</span>
              <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdDrawShaderSource</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">common</span><span class="p">,</span>
              <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdDrawShaderSource</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">source</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sources</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">definitions</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">common</span><span class="p">.</span><span class="n">defines</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;#define &quot;</span>
                    <span class="o">&lt;&lt;</span> <span class="n">common</span><span class="p">.</span><span class="n">defines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span>
                    <span class="o">&lt;&lt;</span> <span class="n">common</span><span class="p">.</span><span class="n">defines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">source</span><span class="p">.</span><span class="n">defines</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;#define &quot;</span>
                    <span class="o">&lt;&lt;</span> <span class="n">source</span><span class="p">.</span><span class="n">defines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span>
                    <span class="o">&lt;&lt;</span> <span class="n">source</span><span class="p">.</span><span class="n">defines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">defString</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>

    <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">defString</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
    <span class="n">sources</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
    <span class="n">sources</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
    <span class="n">sources</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>

    <span class="n">GLuint</span> <span class="n">shader</span> <span class="o">=</span> <span class="n">glCreateShader</span><span class="p">(</span><span class="n">shaderType</span><span class="p">);</span>
    <span class="n">glShaderSource</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">glCompileShader</span><span class="p">(</span><span class="n">shader</span><span class="p">);</span>

    <span class="n">GLint</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">glGetShaderiv</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">GL_COMPILE_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">GL_FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GLchar</span> <span class="n">emsg</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
        <span class="n">glGetShaderInfoLog</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">emsg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emsg</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error compiling GLSL shader: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emsg</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">shader</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h4>_CreateDrawInstance</h4>

<pre><code> Called by base registry when a draw instance is requested.
 Returns a compiled and linked shader program corresponding to 
 a previously created DrawConfig. The effect registry also 
 caches these for efficient re-use.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">EffectDrawRegistry</span><span class="o">::</span><span class="n">InstanceType</span> <span class="o">*</span>
<span class="n">EffectDrawRegistry</span><span class="o">::</span><span class="n">_CreateDrawInstance</span><span class="p">(</span><span class="n">DescType</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">desc</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="n">ConfigType</span> <span class="o">*</span> <span class="n">config</span> <span class="o">=</span> <span class="n">GetDrawConfig</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

    <span class="n">GLuint</span> <span class="n">vertexShader</span> <span class="o">=</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">vertexShader</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
        <span class="n">compileShader</span><span class="p">(</span><span class="n">GL_VERTEX_SHADER</span><span class="p">,</span>
                      <span class="n">config</span><span class="o">-&gt;</span><span class="n">commonShader</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vertexShader</span><span class="p">);</span>

    <span class="n">GLuint</span> <span class="n">tessControlShader</span> <span class="o">=</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">tessControlShader</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
        <span class="n">compileShader</span><span class="p">(</span><span class="n">GL_TESS_CONTROL_SHADER</span><span class="p">,</span>
                      <span class="n">config</span><span class="o">-&gt;</span><span class="n">commonShader</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tessControlShader</span><span class="p">);</span>

    <span class="n">GLuint</span> <span class="n">tessEvalShader</span> <span class="o">=</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">tessEvalShader</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
        <span class="n">compileShader</span><span class="p">(</span><span class="n">GL_TESS_EVALUATION_SHADER</span><span class="p">,</span>
                      <span class="n">config</span><span class="o">-&gt;</span><span class="n">commonShader</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tessEvalShader</span><span class="p">);</span>

    <span class="n">GLuint</span> <span class="n">geometryShader</span> <span class="o">=</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
        <span class="n">compileShader</span><span class="p">(</span><span class="n">GL_GEOMETRY_SHADER</span><span class="p">,</span>
                      <span class="n">config</span><span class="o">-&gt;</span><span class="n">commonShader</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">geometryShader</span><span class="p">);</span>

    <span class="n">GLuint</span> <span class="n">fragmentShader</span> <span class="o">=</span>
        <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
        <span class="n">compileShader</span><span class="p">(</span><span class="n">GL_FRAGMENT_SHADER</span><span class="p">,</span>
                      <span class="n">config</span><span class="o">-&gt;</span><span class="n">commonShader</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">fragmentShader</span><span class="p">);</span>

    <span class="n">InstanceType</span> <span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstanceType</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Create GL program object and attach all of our shaders</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">GLuint</span> <span class="n">program</span> <span class="o">=</span> <span class="n">glCreateProgram</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vertexShader</span><span class="p">)</span>      <span class="n">glAttachShader</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">vertexShader</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tessControlShader</span><span class="p">)</span> <span class="n">glAttachShader</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">tessControlShader</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tessEvalShader</span><span class="p">)</span>    <span class="n">glAttachShader</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">tessEvalShader</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">geometryShader</span><span class="p">)</span>    <span class="n">glAttachShader</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">geometryShader</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fragmentShader</span><span class="p">)</span>    <span class="n">glAttachShader</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">fragmentShader</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Create shader executable</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">glLinkProgram</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>

    <span class="n">CHECK_GL_ERROR</span><span class="p">(</span><span class="s">&quot;CreateDrawInstance link program</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Flag shaders for deletion when program is finished</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">glDeleteShader</span><span class="p">(</span><span class="n">vertexShader</span><span class="p">);</span>
    <span class="n">glDeleteShader</span><span class="p">(</span><span class="n">tessControlShader</span><span class="p">);</span>
    <span class="n">glDeleteShader</span><span class="p">(</span><span class="n">tessEvalShader</span><span class="p">);</span>
    <span class="n">glDeleteShader</span><span class="p">(</span><span class="n">geometryShader</span><span class="p">);</span>
    <span class="n">glDeleteShader</span><span class="p">(</span><span class="n">fragmentShader</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Check results of glLinkProgram</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">GLint</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">glGetProgramiv</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">GL_LINK_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">GL_FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GLchar</span> <span class="n">emsg</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
        <span class="n">glGetProgramInfoLog</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">emsg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emsg</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error linking GLSL program : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emsg</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Assign binding points to uniform blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="cm">/* struct Transform */</span>
    <span class="n">g_transformBinding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">glUniformBlockBinding</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>
        <span class="n">glGetUniformBlockIndex</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;Transform&quot;</span><span class="p">),</span>
        <span class="n">g_transformBinding</span><span class="p">);</span>

    <span class="cm">/* struct Tessellation */</span>
    <span class="n">g_tessellationBinding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">glUniformBlockBinding</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>
        <span class="n">glGetUniformBlockIndex</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;Tessellation&quot;</span><span class="p">),</span>
        <span class="n">g_tessellationBinding</span><span class="p">);</span>

    <span class="cm">/* struct Lighting */</span>
    <span class="n">g_lightingBinding</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">glUniformBlockBinding</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>
        <span class="n">glGetUniformBlockIndex</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;Lighting&quot;</span><span class="p">),</span>
        <span class="n">g_lightingBinding</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Specify texture buffer ID uniforms in shader</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">GLint</span> <span class="n">loc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">loc</span> <span class="o">=</span> <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;g_VertexBuffer&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glProgramUniform1i</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// GL_TEXTURE0</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">loc</span> <span class="o">=</span> <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;g_ValenceBuffer&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glProgramUniform1i</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="c1">// GL_TEXTURE1</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">loc</span> <span class="o">=</span> <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;g_QuadOffsetBuffer&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glProgramUniform1i</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>  <span class="c1">// GL_TEXTURE2</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">loc</span> <span class="o">=</span> <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;g_patchLevelBuffer&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glProgramUniform1i</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>  <span class="c1">// GL_TEXTURE3</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">loc</span> <span class="o">=</span> <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;g_uvFVarBuffer&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glProgramUniform1i</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>  <span class="c1">// GL_TEXTURE4</span>
    <span class="p">}</span>

    <span class="n">instance</span><span class="o">-&gt;</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span><span class="p">;</span>

    <span class="n">CHECK_GL_ERROR</span><span class="p">(</span><span class="s">&quot;CreateDrawInstance leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <hr />

<h3>Shader construction and initialization</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">OpenSubdivShader</span><span class="p">()</span> <span class="p">{...}</span>
<span class="n">OpenSubdivShader</span><span class="o">::~</span><span class="n">OpenSubdivShader</span><span class="p">()</span> <span class="p">{...}</span>
<span class="kt">void</span> <span class="o">*</span> <span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">creator</span><span class="p">()</span> <span class="p">{...}</span>
<span class="n">MStatus</span> <span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">initialize</span><span class="p">()</span> <span class="p">{...}</span>
<span class="kt">void</span> <span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">postConstructor</span><span class="p">()</span> <span class="p">{...}</span>

<span class="n">MStatus</span>
<span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">compute</span><span class="p">(</span><span class="k">const</span> <span class="n">MPlug</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">MDataBlock</span> <span class="o">&amp;</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">return</span> <span class="n">MS</span><span class="o">::</span><span class="n">kSuccess</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h4>updateAttributes</h4>

<pre><code> Called by openSubdivShaderOverride in updateDG.
 Pulls values for all non-internal attributes.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">updateAttributes</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="n">MObject</span> <span class="n">object</span> <span class="o">=</span> <span class="n">thisMObject</span><span class="p">();</span>
    <span class="n">MFnDependencyNode</span> <span class="n">depFn</span><span class="p">(</span><span class="n">object</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Retrieve non-internal attributes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">_diffuse</span> <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">aDiffuse</span><span class="p">);</span>
    <span class="n">_ambient</span> <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">aAmbient</span><span class="p">);</span>
    <span class="n">_specular</span> <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">aSpecular</span><span class="p">);</span>

    <span class="n">getAttribute</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">aWireframe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_wireframe</span><span class="p">);</span>
    <span class="n">getAttribute</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">aShininess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_shininess</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Pull on any plugs that might be connected</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">getAttribute</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">aDiffuseMapFile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_diffuseMapFile</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h4>Main draw method</h4>

<pre><code> Called by OpenSubdivShaderOverride for each renderItem.
 Binds the vertex buffer and calls glDrawElements for 
 each patch.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">draw</span><span class="p">(</span><span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MDrawContext</span> <span class="o">&amp;</span><span class="n">mDrawContext</span><span class="p">,</span>
                             <span class="n">OsdMeshData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">glPushAttrib</span><span class="p">(</span><span class="n">GL_POLYGON_BIT</span><span class="o">|</span><span class="n">GL_ENABLE_BIT</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_wireframe</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glPolygonMode</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span> <span class="n">GL_LINE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">glPolygonMode</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span> <span class="n">GL_FILL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">CHECK_GL_ERROR</span><span class="p">(</span><span class="s">&quot;draw begin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>If shader source attribute has changed, update effectRegistry</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">updateRegistry</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Bind position vertex buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">GLuint</span> <span class="n">bPosition</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bindPositionVBO</span><span class="p">();</span>
    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawContext</span> <span class="o">*</span><span class="n">osdDrawContext</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">getDrawContext</span><span class="p">();</span>

    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_ARRAY_BUFFER</span><span class="p">,</span> <span class="n">bPosition</span><span class="p">);</span>
    <span class="n">glVertexAttribPointer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GL_FLOAT</span><span class="p">,</span> <span class="n">GL_FALSE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GLfloat</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">glEnableVertexAttribArray</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">patchIndexBuffer</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Get list of patches from OSD</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdPatchArrayVector</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">patches</span> <span class="o">=</span>
        <span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">patchArrays</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Draw patches</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">patches</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdPatchArray</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="n">GLint</span> <span class="n">surfaceProgram</span> <span class="o">=</span> <span class="n">bindProgram</span><span class="p">(</span><span class="n">mDrawContext</span><span class="p">,</span> <span class="n">osdDrawContext</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">kPerVertex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">glPatchParameteri</span><span class="p">(</span><span class="n">GL_PATCH_VERTICES</span><span class="p">,</span> <span class="n">patch</span><span class="p">.</span><span class="n">patchSize</span><span class="p">);</span>

            <span class="n">glDrawElements</span><span class="p">(</span><span class="n">GL_PATCHES</span><span class="p">,</span>
                           <span class="n">patch</span><span class="p">.</span><span class="n">numIndices</span><span class="p">,</span> <span class="n">GL_UNSIGNED_INT</span><span class="p">,</span>
                           <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">firstIndex</span> <span class="o">*</span>
                                                    <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">glDrawElements</span><span class="p">(</span><span class="n">_scheme</span> <span class="o">==</span> <span class="n">OsdMeshData</span><span class="o">::</span><span class="n">kLoop</span> <span class="o">?</span> <span class="n">GL_TRIANGLES</span> <span class="o">:</span> <span class="n">GL_LINES_ADJACENCY</span><span class="p">,</span>
                           <span class="n">patch</span><span class="p">.</span><span class="n">numIndices</span><span class="p">,</span> <span class="n">GL_UNSIGNED_INT</span><span class="p">,</span>
                           <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">firstIndex</span> <span class="o">*</span>
                                                    <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)));</span>
        <span class="p">}</span>
        <span class="n">CHECK_GL_ERROR</span><span class="p">(</span><span class="s">&quot;post draw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Clear state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">glUseProgram</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">glDisableVertexAttribArray</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_ARRAY_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">glPopAttrib</span><span class="p">();</span>

    <span class="n">CHECK_GL_ERROR</span><span class="p">(</span><span class="s">&quot;draw end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h4>bindTexture</h4>

<pre><code> Utility routine which binds a single texture map
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">GLuint</span> 
<span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">bindTexture</span><span class="p">(</span> <span class="k">const</span> <span class="n">MString</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">textureUnit</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">GLuint</span> <span class="n">textureId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">MHWRender</span><span class="o">::</span><span class="n">MTexture</span> <span class="o">*</span><span class="n">mTexture</span> <span class="o">=</span> <span class="n">_theTextureManager</span><span class="o">-&gt;</span><span class="n">acquireTexture</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mTexture</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">textureId</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">GLuint</span><span class="o">*</span><span class="p">)</span><span class="n">mTexture</span><span class="o">-&gt;</span><span class="n">resourceHandle</span><span class="p">();</span>
        <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE0</span><span class="o">+</span><span class="n">textureUnit</span><span class="p">);</span>
        <span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">textureId</span><span class="p">);</span>
        <span class="n">glTexParameteri</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">GL_TEXTURE_WRAP_S</span><span class="p">,</span> <span class="n">GL_CLAMP_TO_EDGE</span><span class="p">);</span>
        <span class="n">glTexParameteri</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">GL_TEXTURE_WRAP_T</span><span class="p">,</span> <span class="n">GL_CLAMP_TO_EDGE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Can&#39;t read texture file: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">.</span><span class="n">asChar</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">textureId</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <h4>updateRegistry</h4>

<pre><code> Evaluates dirty flags and updates the effect registry if any
 attributes have changed that require the shader to be rebuilt
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">updateRegistry</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* If adaptive flag has changed, update the effectRegistry accordingly */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_adaptiveDirty</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_effectRegistry</span><span class="p">.</span><span class="n">setIsAdaptive</span><span class="p">(</span><span class="n">_adaptive</span><span class="p">);</span>
        <span class="n">_adaptiveDirty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">MHWRender</span><span class="o">::</span><span class="n">MRenderer</span> <span class="o">*</span><span class="n">theRenderer</span> <span class="o">=</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MRenderer</span><span class="o">::</span><span class="n">theRenderer</span><span class="p">();</span>
    <span class="n">_theTextureManager</span> <span class="o">=</span> <span class="n">theRenderer</span><span class="o">-&gt;</span><span class="n">getTextureManager</span><span class="p">();</span>

    <span class="cm">/* If diffuse texture has changed, update the effectRegistry accordingly */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_diffuseMapDirty</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GLuint</span> <span class="n">diffMapId</span> <span class="o">=</span> <span class="n">bindTexture</span><span class="p">(</span> <span class="n">_diffuseMapFile</span><span class="p">,</span> <span class="n">DIFF_TEXTURE_UNIT</span> <span class="p">);</span>
        <span class="n">_effectRegistry</span><span class="p">.</span><span class="n">setDiffuseId</span><span class="p">(</span><span class="n">diffMapId</span><span class="p">);</span>
        <span class="n">_diffuseMapDirty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* If shader source has changed, update the effectRegistry accordingly */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_shaderSourceDirty</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">_shaderSource</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">_effectRegistry</span><span class="p">.</span><span class="n">getShaderSource</span><span class="p">()</span> <span class="o">!=</span> <span class="n">defaultShaderSource</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">_effectRegistry</span><span class="p">.</span><span class="n">setShaderSource</span><span class="p">(</span><span class="n">defaultShaderSource</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">_effectRegistry</span><span class="p">.</span><span class="n">getShaderSource</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_shaderSource</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">_effectRegistry</span><span class="p">.</span><span class="n">setShaderSource</span><span class="p">(</span><span class="n">_shaderSource</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">_shaderSourceDirty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h4>bindProgram</h4>

<pre><code> Do all the work to build and install shader including
 set up buffer blocks for uniform variables, set up
 default lighting parameters, pass material uniforms
 and bind texture buffers used by texture maps and by
 OpenSubdiv's built-in shading code.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">GLuint</span>
<span class="n">OpenSubdivShader</span><span class="o">::</span><span class="n">bindProgram</span><span class="p">(</span><span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MDrawContext</span> <span class="o">&amp;</span>     <span class="n">mDrawContext</span><span class="p">,</span>
                                    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawContext</span> <span class="o">*</span><span class="n">osdDrawContext</span><span class="p">,</span>
                              <span class="k">const</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdPatchArray</span> <span class="o">&amp;</span>   <span class="n">patch</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">CHECK_GL_ERROR</span><span class="p">(</span><span class="s">&quot;bindProgram begin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Primitives are triangles for Loop subdivision, quads otherwise</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">Effect</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">_scheme</span> <span class="o">==</span> <span class="n">OsdMeshData</span><span class="o">::</span><span class="n">kLoop</span><span class="p">)</span> <span class="o">?</span> <span class="n">kTriFill</span> <span class="o">:</span> <span class="n">kQuadFill</span><span class="p">;</span>
    <span class="n">EffectDesc</span> <span class="n">effectDesc</span><span class="p">(</span> <span class="n">patch</span><span class="p">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">effect</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Build shader</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">EffectDrawRegistry</span><span class="o">::</span><span class="n">InstanceType</span> <span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">_effectRegistry</span><span class="p">.</span><span class="n">GetDrawInstance</span><span class="p">(</span><span class="n">effectDesc</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Install shader</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">GLuint</span> <span class="n">program</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">;</span>
    <span class="n">glUseProgram</span><span class="p">(</span><span class="n">program</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Update and bind transform state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">struct</span> <span class="n">Transform</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">ModelViewMatrix</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
        <span class="kt">float</span> <span class="n">ProjectionMatrix</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
        <span class="kt">float</span> <span class="n">ModelViewProjectionMatrix</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">transformData</span><span class="p">;</span>
    <span class="n">setMatrix</span><span class="p">(</span><span class="n">mDrawContext</span><span class="p">.</span><span class="n">getMatrix</span><span class="p">(</span><span class="n">MHWRender</span><span class="o">::</span><span class="n">MDrawContext</span><span class="o">::</span><span class="n">kWorldViewMtx</span><span class="p">),</span>
              <span class="n">transformData</span><span class="p">.</span><span class="n">ModelViewMatrix</span><span class="p">);</span>
    <span class="n">setMatrix</span><span class="p">(</span><span class="n">mDrawContext</span><span class="p">.</span><span class="n">getMatrix</span><span class="p">(</span><span class="n">MHWRender</span><span class="o">::</span><span class="n">MDrawContext</span><span class="o">::</span><span class="n">kProjectionMtx</span><span class="p">),</span>
              <span class="n">transformData</span><span class="p">.</span><span class="n">ProjectionMatrix</span><span class="p">);</span>
    <span class="n">setMatrix</span><span class="p">(</span><span class="n">mDrawContext</span><span class="p">.</span><span class="n">getMatrix</span><span class="p">(</span><span class="n">MHWRender</span><span class="o">::</span><span class="n">MDrawContext</span><span class="o">::</span><span class="n">kWorldViewProjMtx</span><span class="p">),</span>
              <span class="n">transformData</span><span class="p">.</span><span class="n">ModelViewProjectionMatrix</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_transformUB</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glGenBuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_transformUB</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_transformUB</span><span class="p">);</span>
        <span class="n">glBufferData</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">transformData</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GL_STATIC_DRAW</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_transformUB</span><span class="p">);</span>
    <span class="n">glBufferSubData</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">transformData</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">transformData</span><span class="p">);</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">glBindBufferBase</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_transformBinding</span><span class="p">,</span> <span class="n">g_transformUB</span><span class="p">);</span>

<span class="cp">#define MAX_LEVEL 16</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Update and bind tessellation state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">struct</span> <span class="n">Tessellation</span> <span class="p">{</span>
        <span class="cm">/* XXX: std140 layout requires vec4 aligns for every entry */</span>
        <span class="kt">float</span> <span class="n">TessLevelInner</span><span class="p">[</span><span class="n">MAX_LEVEL</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
        <span class="kt">float</span> <span class="n">TessLevelOuter</span><span class="p">[</span><span class="n">MAX_LEVEL</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">GregoryQuadOffsetBase</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">LevelBase</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">tessellationData</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">tessFactor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">_tessFactor</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LEVEL</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tessellationData</span><span class="p">.</span><span class="n">TessLevelInner</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">tessFactor</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
        <span class="n">tessellationData</span><span class="p">.</span><span class="n">TessLevelOuter</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">tessFactor</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">tessellationData</span><span class="p">.</span><span class="n">GregoryQuadOffsetBase</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">gregoryQuadOffsetBase</span><span class="p">;</span>
    <span class="n">tessellationData</span><span class="p">.</span><span class="n">LevelBase</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">levelBase</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_tessellationUB</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glGenBuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_tessellationUB</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_tessellationUB</span><span class="p">);</span>
        <span class="n">glBufferData</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">tessellationData</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GL_STATIC_DRAW</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_tessellationUB</span><span class="p">);</span>
    <span class="n">glBufferSubData</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tessellationData</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tessellationData</span><span class="p">);</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">glBindBufferBase</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span>
                     <span class="n">g_tessellationBinding</span><span class="p">,</span>
                     <span class="n">g_tessellationUB</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Update and bind lighting state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">int</span> <span class="n">numLights</span> <span class="o">=</span> <span class="n">mDrawContext</span><span class="p">.</span><span class="n">numberOfActiveLights</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">Lighting</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">Light</span> <span class="p">{</span>
            <span class="kt">float</span> <span class="n">position</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
            <span class="kt">float</span> <span class="n">diffuse</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
            <span class="kt">float</span> <span class="n">ambient</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
            <span class="kt">float</span> <span class="n">specular</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="p">}</span> <span class="n">lightSource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">lightingData</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lightingData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lightingData</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numLights</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MFloatPointArray</span> <span class="n">positions</span><span class="p">;</span>
        <span class="n">MFloatVector</span> <span class="n">direction</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">intensity</span><span class="p">;</span>
        <span class="n">MColor</span> <span class="n">color</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">hasDirection</span><span class="p">,</span> <span class="n">hasPosition</span><span class="p">;</span>
        <span class="n">mDrawContext</span><span class="p">.</span><span class="n">getLightInformation</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span>
                                    <span class="n">color</span><span class="p">,</span> <span class="n">hasDirection</span><span class="p">,</span> <span class="n">hasPosition</span><span class="p">);</span>

        <span class="n">MMatrix</span> <span class="n">modelView</span> <span class="o">=</span> <span class="n">mDrawContext</span><span class="p">.</span><span class="n">getMatrix</span><span class="p">(</span><span class="n">MHWRender</span><span class="o">::</span><span class="n">MDrawContext</span><span class="o">::</span><span class="n">kWorldViewMtx</span><span class="p">);</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">MVector</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="n">modelView</span><span class="p">;</span>

        <span class="n">Lighting</span><span class="o">::</span><span class="n">Light</span> <span class="o">&amp;</span><span class="n">light</span> <span class="o">=</span> <span class="n">lightingData</span><span class="p">.</span><span class="n">lightSource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hasDirection</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">light</span><span class="p">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">light</span><span class="p">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">light</span><span class="p">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">light</span><span class="p">.</span><span class="n">diffuse</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">intensity</span><span class="p">;</span>
                <span class="n">light</span><span class="p">.</span><span class="n">ambient</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">intensity</span><span class="p">;</span>
                <span class="n">light</span><span class="p">.</span><span class="n">specular</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">intensity</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_lightingUB</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glGenBuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_lightingUB</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_lightingUB</span><span class="p">);</span>
        <span class="n">glBufferData</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">lightingData</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GL_STATIC_DRAW</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_lightingUB</span><span class="p">);</span>
    <span class="n">glBufferSubData</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lightingData</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lightingData</span><span class="p">);</span>
    <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">glBindBufferBase</span><span class="p">(</span><span class="n">GL_UNIFORM_BUFFER</span><span class="p">,</span> <span class="n">g_lightingBinding</span><span class="p">,</span> <span class="n">g_lightingUB</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Update other uniforms</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">float</span> <span class="n">color</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
    <span class="n">_diffuse</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">glProgramUniform4fv</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>
                        <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;diffuseColor&quot;</span><span class="p">),</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
    <span class="n">_ambient</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">glProgramUniform4fv</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>
                        <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;ambientColor&quot;</span><span class="p">),</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
    <span class="n">_specular</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">glProgramUniform4fv</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>
                        <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;specularColor&quot;</span><span class="p">),</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
    <span class="n">glProgramUniform1f</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>
                       <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;shininess&quot;</span><span class="p">),</span>
                       <span class="n">_shininess</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Bind diffuse map</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">_effectRegistry</span><span class="p">.</span><span class="n">getDiffuseId</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GLint</span> <span class="n">difmap</span> <span class="o">=</span> <span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;diffuseMap&quot;</span><span class="p">);</span>
        <span class="n">glProgramUniform1i</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">difmap</span><span class="p">,</span> <span class="n">DIFF_TEXTURE_UNIT</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Bind all texture buffers</p>

<pre><code> OpenSubdiv's geometric shading code depends on additional 
 GL texture buffers. These are managed by the DrawContext 
 and must be bound for use by the program in addition to 
 any buffers used by the client/application shading code.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">vertexTextureBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE0</span><span class="p">);</span>
        <span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_BUFFER</span><span class="p">,</span>
                      <span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">vertexTextureBuffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">vertexValenceTextureBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE1</span><span class="p">);</span>
        <span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_BUFFER</span><span class="p">,</span>
                      <span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">vertexValenceTextureBuffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">quadOffsetTextureBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE2</span><span class="p">);</span>
        <span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_BUFFER</span><span class="p">,</span>
                      <span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">quadOffsetTextureBuffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">patchLevelTextureBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE3</span><span class="p">);</span>
        <span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_BUFFER</span><span class="p">,</span>
                      <span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">patchLevelTextureBuffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">fvarDataTextureBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glActiveTexture</span><span class="p">(</span> <span class="n">GL_TEXTURE4</span> <span class="p">);</span>
        <span class="n">glBindTexture</span><span class="p">(</span>  <span class="n">GL_TEXTURE_BUFFER</span><span class="p">,</span> 
                      <span class="n">osdDrawContext</span><span class="o">-&gt;</span><span class="n">fvarDataTextureBuffer</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE0</span><span class="p">);</span>

    <span class="n">CHECK_GL_ERROR</span><span class="p">(</span><span class="s">&quot;bindProgram leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">program</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>OpenSubdivShaderOverride.h</h3>

<pre><code> Viewport 2.0 override for OpenSubdivShader
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">OpenSubdivShaderOverride</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MPxShaderOverride</span> 
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="cm">/* ... Standard MPxShaderOverride methods and definitions ... */</span>
    
<span class="k">private</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h5>Pointer to associated shader</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">OpenSubdivShader</span> <span class="o">*</span><span class="n">_shader</span><span class="p">;</span>

<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>OpenSubdivShaderOverride.cpp</h3>

<pre><code> Viewport 2.0 override for OpenSubdivShader, implementing
 custom shading for OpenSubdiv patches.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* Include GLEW before Maya and OSD includes */</span>
<span class="cp">#include &lt;GL/glew.h&gt;</span>

<span class="cm">/* ... System includes ... */</span>
<span class="cm">/* ... Maya includes ... */</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Set up compute controllers for each available compute kernel.</p>

<p><code>dyu - what exactly is a compute controller?</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cp">#include &lt;osd/cpuComputeController.h&gt;</span>
<span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCpuComputeController</span> <span class="o">*</span><span class="n">g_cpuComputeController</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_OPENMP</span>
    <span class="cp">#include &lt;osd/ompComputeController.h&gt;</span>
    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdOmpComputeController</span> <span class="o">*</span><span class="n">g_ompComputeController</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="cp">#include &lt;osd/clComputeController.h&gt;</span>
    <span class="n">cl_context</span> <span class="n">g_clContext</span><span class="p">;</span>
    <span class="n">cl_command_queue</span> <span class="n">g_clQueue</span><span class="p">;</span>
    <span class="cp">#include &quot;../common/clInit.h&quot;</span>
    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCLComputeController</span> <span class="o">*</span><span class="n">g_clComputeController</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="cp">#include &lt;osd/cudaComputeController.h&gt;</span>
    <span class="k">extern</span> <span class="kt">void</span> <span class="n">cudaInit</span><span class="p">();</span>
    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCudaComputeController</span> <span class="o">*</span><span class="n">g_cudaComputeController</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">OpenSubdivShaderOverride</span><span class="p">(</span><span class="k">const</span> <span class="n">MObject</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="p">{...}</span>
<span class="n">OpenSubdivShaderOverride</span><span class="o">::~</span><span class="n">OpenSubdivShaderOverride</span><span class="p">()</span> <span class="p">{...}</span>
<span class="n">MHWRender</span><span class="o">::</span><span class="n">MPxShaderOverride</span><span class="o">*</span> <span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">creator</span><span class="p">(</span><span class="k">const</span> <span class="n">MObject</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="p">{...}</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h4>attrChangedCB</h4>

<pre><code> Informs us whenever an attribute on the shape node changes.
 Overkill since we really only want to know if the topology 
 changes (e.g. an edge crease is added or changed) but Maya 
 doesn't give us access to a callback that fine-grained. 
 MMessage::PolyTopologyChangedCallback sounds promising 
 but only calls back on a single change for any edit 
 (i.e. not while dragging).
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*static*/</span>
<span class="kt">void</span> 
<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">attrChangedCB</span><span class="p">(</span><span class="n">MNodeMessage</span><span class="o">::</span><span class="n">AttributeMessage</span> <span class="n">msg</span><span class="p">,</span> <span class="n">MPlug</span> <span class="o">&amp;</span> <span class="n">plug</span><span class="p">,</span>
                                        <span class="n">MPlug</span> <span class="o">&amp;</span> <span class="n">otherPlug</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">clientData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* We only care if the plug is outMesh and the action is &quot;evaluate&quot; */</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">msg</span> <span class="o">&amp;</span> <span class="n">MNodeMessage</span><span class="o">::</span><span class="n">kAttributeEval</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">OsdMeshData</span> <span class="o">*</span><span class="n">meshData</span> <span class="o">=</span> <span class="p">(</span><span class="n">OsdMeshData</span><span class="o">*</span><span class="p">)</span><span class="n">clientData</span><span class="p">;</span>
    <span class="n">MFnDependencyNode</span> <span class="n">depNodeFn</span><span class="p">(</span><span class="n">meshData</span><span class="o">-&gt;</span><span class="n">getDagPath</span><span class="p">().</span><span class="n">node</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">plug</span> <span class="o">==</span> <span class="n">depNodeFn</span><span class="p">.</span><span class="n">attribute</span><span class="p">(</span><span class="s">&quot;outMesh&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">meshData</span><span class="o">-&gt;</span><span class="n">setMeshTopoDirty</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h4>addTopologyChangedCallbacks</h4>

<pre><code> Add a callback to inform us when topology might be changing 
 so we can update the HBR mesh accordingly.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">addTopologyChangedCallbacks</span><span class="p">(</span> <span class="k">const</span> <span class="n">MDagPath</span><span class="o">&amp;</span> <span class="n">dagPath</span><span class="p">,</span> <span class="n">OsdMeshData</span> <span class="o">*</span><span class="n">data</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">MStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MS</span><span class="o">::</span><span class="n">kSuccess</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Extract shape node and add callback to let us know when an attribute changes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">MDagPath</span> <span class="n">meshDagPath</span> <span class="o">=</span> <span class="n">dagPath</span><span class="p">;</span>
    <span class="n">meshDagPath</span><span class="p">.</span><span class="n">extendToShape</span><span class="p">();</span>
    <span class="n">MObject</span> <span class="n">shapeNode</span> <span class="o">=</span> <span class="n">meshDagPath</span><span class="p">.</span><span class="n">node</span><span class="p">();</span>
    <span class="n">MCallbackId</span> <span class="n">id</span> <span class="o">=</span> <span class="n">MNodeMessage</span><span class="o">::</span><span class="n">addAttributeChangedCallback</span><span class="p">(</span><span class="n">shapeNode</span><span class="p">,</span> 
                                    <span class="n">attrChangedCB</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Keep track so we can delete callbacks in destructor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">_callbackIds</span><span class="p">.</span><span class="n">append</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;MNodeMessage.addCallback failed&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h4>initialize</h4>

<pre><code> Set up vertex buffer descriptors and geometry requirements
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">MString</span>
<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">const</span> <span class="n">MInitContext</span> <span class="o">&amp;</span><span class="n">initContext</span><span class="p">,</span>
                                           <span class="n">MInitFeedback</span> <span class="o">&amp;</span><span class="n">initFeedback</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MString</span> <span class="n">empty</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Roundabout way of getting positions pulled into our OsdBufferGenerator
where we can manage the VBO memory size.</p>

<p>Needs to be re-visited, re-factored, optimized, etc.</p>

<p><code>dyu - can we add any more explanation about why this is done this way?</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">{</span>
        <span class="n">MHWRender</span><span class="o">::</span><span class="n">MVertexBufferDescriptor</span> <span class="n">positionDesc</span><span class="p">(</span>
            <span class="n">empty</span><span class="p">,</span>
            <span class="n">MHWRender</span><span class="o">::</span><span class="n">MGeometry</span><span class="o">::</span><span class="n">kPosition</span><span class="p">,</span>
            <span class="n">MHWRender</span><span class="o">::</span><span class="n">MGeometry</span><span class="o">::</span><span class="n">kFloat</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">);</span>
        <span class="n">addGeometryRequirement</span><span class="p">(</span><span class="n">positionDesc</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="n">MHWRender</span><span class="o">::</span><span class="n">MVertexBufferDescriptor</span> <span class="n">positionDesc</span><span class="p">(</span>
            <span class="s">&quot;osdPosition&quot;</span><span class="p">,</span>
            <span class="n">MHWRender</span><span class="o">::</span><span class="n">MGeometry</span><span class="o">::</span><span class="n">kTangent</span><span class="p">,</span>
            <span class="n">MHWRender</span><span class="o">::</span><span class="n">MGeometry</span><span class="o">::</span><span class="n">kFloat</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">);</span>
        <span class="n">positionDesc</span><span class="p">.</span><span class="n">setSemanticName</span><span class="p">(</span><span class="s">&quot;osdPosition&quot;</span><span class="p">);</span>
        <span class="n">addGeometryRequirement</span><span class="p">(</span><span class="n">positionDesc</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Build data object for managing OSD mesh, pass in as custom data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">initFeedback</span><span class="p">.</span><span class="n">customData</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OsdMeshData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OsdMeshData</span><span class="p">(</span><span class="n">initContext</span><span class="p">.</span><span class="n">dagPath</span><span class="p">);</span>
        <span class="n">initFeedback</span><span class="p">.</span><span class="n">customData</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Add a Maya callback so we can rebuild HBR mesh if topology changes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">addTopologyChangedCallbacks</span><span class="p">(</span> <span class="n">initContext</span><span class="p">.</span><span class="n">dagPath</span><span class="p">,</span> <span class="p">(</span><span class="n">OsdMeshData</span><span class="o">*</span><span class="p">)</span><span class="n">initFeedback</span><span class="p">.</span><span class="n">customData</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">MString</span><span class="p">(</span><span class="s">&quot;OpenSubdivShaderOverride&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <h4>updateDG</h4>

<pre><code> Save pointer to shader so we have access down the line.
 Call shader to update any attributes it needs to.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">updateDG</span><span class="p">(</span><span class="n">MObject</span> <span class="n">object</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">object</span> <span class="o">==</span> <span class="n">MObject</span><span class="o">::</span><span class="n">kNullObj</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Save pointer to shader for access from draw()</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">_shader</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">OpenSubdivShader</span><span class="o">*&gt;</span><span class="p">(</span>
        <span class="n">MPxHwShaderNode</span><span class="o">::</span><span class="n">getHwShaderNodePtr</span><span class="p">(</span><span class="n">object</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Get updated attributes from shader</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">_shader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_shader</span><span class="o">-&gt;</span><span class="n">updateAttributes</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">updateDevice</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">endUpdate</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <h4>Override draw method.</h4>

<p>Setup draw state and call osdMeshData methods to setup 
and refine geometry.  Call to shader to do actual drawing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">bool</span>
<span class="n">OpenSubdivShaderOverride</span><span class="o">::</span><span class="n">draw</span><span class="p">(</span>
    <span class="n">MHWRender</span><span class="o">::</span><span class="n">MDrawContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MRenderItemList</span> <span class="o">&amp;</span><span class="n">renderItemList</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
    <span class="p">{</span>
        <span class="n">MHWRender</span><span class="o">::</span><span class="n">MStateManager</span> <span class="o">*</span><span class="n">stateMgr</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">getStateManager</span><span class="p">();</span>
        <span class="k">static</span> <span class="k">const</span> <span class="n">MDepthStencilState</span> <span class="o">*</span> <span class="n">depthState</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">depthState</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">MDepthStencilStateDesc</span> <span class="n">desc</span><span class="p">;</span>
            <span class="n">depthState</span> <span class="o">=</span> <span class="n">stateMgr</span><span class="o">-&gt;</span><span class="n">acquireDepthStencilState</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">static</span> <span class="k">const</span> <span class="n">MBlendState</span> <span class="o">*</span><span class="n">blendState</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blendState</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">MBlendStateDesc</span> <span class="n">desc</span><span class="p">;</span>

            <span class="kt">int</span> <span class="n">ntargets</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">independentBlendEnable</span> <span class="o">?</span>
                <span class="n">MHWRender</span><span class="o">::</span><span class="n">MBlendState</span><span class="o">::</span><span class="n">kMaxTargets</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntargets</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">desc</span><span class="p">.</span><span class="n">targetBlends</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blendEnable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">blendState</span> <span class="o">=</span> <span class="n">stateMgr</span><span class="o">-&gt;</span><span class="n">acquireBlendState</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">stateMgr</span><span class="o">-&gt;</span><span class="n">setDepthStencilState</span><span class="p">(</span><span class="n">depthState</span><span class="p">);</span>
        <span class="n">stateMgr</span><span class="o">-&gt;</span><span class="n">setBlendState</span><span class="p">(</span><span class="n">blendState</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">renderItemList</span><span class="p">.</span><span class="n">length</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MRenderItem</span> <span class="o">*</span><span class="n">renderItem</span> <span class="o">=</span> <span class="n">renderItemList</span><span class="p">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">OsdMeshData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
            <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">OsdMeshData</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">renderItem</span><span class="o">-&gt;</span><span class="n">customData</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>If attributes or topology have changed which affect 
the HBR mesh it will be regenerated here.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">data</span><span class="o">-&gt;</span><span class="n">rebuildHbrMeshIfNeeded</span><span class="p">(</span><span class="n">_shader</span><span class="p">);</span>

        <span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MVertexBuffer</span> <span class="o">*</span><span class="n">position</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MGeometry</span> <span class="o">*</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">renderItem</span><span class="o">-&gt;</span><span class="n">geometry</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geometry</span><span class="o">-&gt;</span><span class="n">vertexBufferCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MVertexBuffer</span> <span class="o">*</span><span class="n">vb</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">-&gt;</span><span class="n">vertexBuffer</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MVertexBufferDescriptor</span> <span class="o">&amp;</span><span class="n">vdesc</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">vdesc</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;osdPosition&quot;</span><span class="p">)</span>
                    <span class="n">position</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>If HBR mesh was regenerated, rebuild FAR mesh factory
and recreate OSD draw context</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">data</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Refine geometry</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">data</span><span class="o">-&gt;</span><span class="n">updateGeometry</span><span class="p">(</span><span class="n">position</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Draw patches</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">_shader</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <hr />

<h4>OsdBufferGenerator</h4>

<p>Vertex buffer generator for OpenSubdiv geometry</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p><code>dyu - might need some explanation from takahito here</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">OsdBufferGenerator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MPxVertexBufferGenerator</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">OsdBufferGenerator</span><span class="p">()</span> <span class="p">{}</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">OsdBufferGenerator</span><span class="p">()</span> <span class="p">{}</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">getSourceIndexing</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">MDagPath</span> <span class="o">&amp;</span><span class="n">dagPath</span><span class="p">,</span>
        <span class="n">MHWRender</span><span class="o">::</span><span class="n">MComponentDataIndexing</span> <span class="o">&amp;</span><span class="n">sourceIndexing</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="n">MFnMesh</span> <span class="n">mesh</span><span class="p">(</span><span class="n">dagPath</span><span class="p">.</span><span class="n">node</span><span class="p">());</span>

        <span class="n">MIntArray</span> <span class="n">vertexCount</span><span class="p">,</span> <span class="n">vertexList</span><span class="p">;</span>
        <span class="n">mesh</span><span class="p">.</span><span class="n">getVertices</span><span class="p">(</span><span class="n">vertexCount</span><span class="p">,</span> <span class="n">vertexList</span><span class="p">);</span>

        <span class="n">MUintArray</span> <span class="o">&amp;</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">sourceIndexing</span><span class="p">.</span><span class="n">indices</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vertexList</span><span class="p">.</span><span class="n">length</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">vertices</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">vertexList</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

        <span class="n">sourceIndexing</span><span class="p">.</span><span class="n">setComponentType</span><span class="p">(</span><span class="n">MComponentDataIndexing</span><span class="o">::</span><span class="n">kFaceVertex</span><span class="p">);</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">getSourceStreams</span><span class="p">(</span><span class="k">const</span> <span class="n">MDagPath</span> <span class="o">&amp;</span><span class="n">dagPath</span><span class="p">,</span>
                                  <span class="n">MStringArray</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#if MAYA_API_VERSION &gt;= 201350</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">createVertexStream</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">MDagPath</span> <span class="o">&amp;</span><span class="n">dagPath</span><span class="p">,</span> 
              <span class="n">MVertexBuffer</span> <span class="o">&amp;</span><span class="n">vertexBuffer</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">MComponentDataIndexing</span> <span class="o">&amp;</span><span class="n">targetIndexing</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">MComponentDataIndexing</span> <span class="o">&amp;</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">MVertexBufferArray</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
<span class="cp">#else</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">createVertexStream</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">MDagPath</span> <span class="o">&amp;</span><span class="n">dagPath</span><span class="p">,</span> <span class="n">MVertexBuffer</span> <span class="o">&amp;</span><span class="n">vertexBuffer</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">MComponentDataIndexing</span> <span class="o">&amp;</span><span class="n">targetIndexing</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
<span class="cp">#endif</span>
        <span class="k">const</span> <span class="n">MVertexBufferDescriptor</span> <span class="o">&amp;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">vertexBuffer</span><span class="p">.</span><span class="n">descriptor</span><span class="p">();</span>

        <span class="n">MFnMesh</span> <span class="n">meshFn</span><span class="p">(</span><span class="n">dagPath</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">nVertices</span> <span class="o">=</span> <span class="n">meshFn</span><span class="p">.</span><span class="n">numVertices</span><span class="p">();</span>
        <span class="n">MFloatPointArray</span> <span class="n">points</span><span class="p">;</span>
        <span class="n">meshFn</span><span class="p">.</span><span class="n">getPoints</span><span class="p">(</span><span class="n">points</span><span class="p">);</span>

<span class="cp">#if MAYA_API_VERSION &gt;= 201350</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">vertexBuffer</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">nVertices</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
<span class="cp">#else</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">vertexBuffer</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">nVertices</span><span class="p">));</span>
<span class="cp">#endif</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nVertices</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
            <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
            <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">vertexBuffer</span><span class="p">.</span><span class="n">commit</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">MPxVertexBufferGenerator</span> <span class="o">*</span><span class="n">positionBufferCreator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OsdBufferGenerator</span><span class="p">();</span>
    <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>osdMeshData.h</h3>

<p>Class definition for OpenSubdiv MUserData used as custom data
in OpenSubdivShaderOverride</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p><code>dyu - hi again, need intelligent descriptions here too!</code>
 <code>although maybe not if these are described elsewhere</code>
 <code>getting a bit blurry now</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cp">#include &lt;far/meshFactory.h&gt;</span>
<span class="cp">#include &lt;osd/glDrawContext.h&gt;</span>

<span class="cp">#include &lt;osd/cpuGLVertexBuffer.h&gt;</span>
<span class="cp">#include &lt;osd/cpuComputeContext.h&gt;</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="cp">#include &lt;osd/clGLVertexBuffer.h&gt;</span>
    <span class="cp">#include &lt;osd/clComputeContext.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="cp">#include &lt;osd/cudaGLVertexBuffer.h&gt;</span>
    <span class="cp">#include &lt;osd/cudaComputeContext.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/* ... Maya includes ... */</span>


<span class="k">class</span> <span class="nc">OsdMeshData</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MUserData</span> 
<span class="p">{</span>
<span class="p">...</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>osdMeshData.cpp</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ... Maya includes ... */</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Set up compute controllers for each available compute kernel.</p>

<p><code>dyu - what exactly is a compute controller?</code>
 <code>same decription from above...</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cp">#include &lt;osd/cpuDispatcher.h&gt;</span>
<span class="cp">#include &lt;osd/cpuComputeController.h&gt;</span>
<span class="k">extern</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCpuComputeController</span> <span class="o">*</span><span class="n">g_cpuComputeController</span><span class="p">;</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_OPENMP</span>
<span class="cp">#include &lt;osd/ompDispatcher.h&gt;</span>
<span class="cp">#include &lt;osd/ompComputeController.h&gt;</span>
<span class="k">extern</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdOmpComputeController</span> <span class="o">*</span><span class="n">g_ompComputeController</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
<span class="cp">#include &lt;osd/clDispatcher.h&gt;</span>
<span class="cp">#include &lt;osd/clComputeController.h&gt;</span>
<span class="k">extern</span> <span class="n">cl_context</span> <span class="n">g_clContext</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">cl_command_queue</span> <span class="n">g_clQueue</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCLComputeController</span> <span class="o">*</span><span class="n">g_clComputeController</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
<span class="cp">#include &lt;osd/cudaDispatcher.h&gt;</span>
<span class="cp">#include &lt;osd/cudaComputeController.h&gt;</span>
<span class="k">extern</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCudaComputeController</span> <span class="o">*</span><span class="n">g_cudaComputeController</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;osd/glDrawContext.h&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <h4>Constructor</h4>

<pre><code> Initialize all context and buffers to NULL
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">OsdMeshData</span><span class="o">::</span><span class="n">OsdMeshData</span><span class="p">(</span><span class="k">const</span> <span class="n">MDagPath</span><span class="o">&amp;</span> <span class="n">meshDagPath</span><span class="p">)</span> <span class="p">{...}</span>
    <span class="o">:</span> <span class="n">MUserData</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span> 
<span class="p">{</span>
    <span class="n">_cpuComputeContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">_cpuPositionBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="n">_clComputeContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">_clPositionBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="n">_cudaComputeContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">_cudaPositionBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <h4>Destructor</h4>

<pre><code> Delete meshes, clear contexts and buffers
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">OsdMeshData</span><span class="o">::~</span><span class="n">OsdMeshData</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="k">delete</span> <span class="n">_hbrmesh</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">_farmesh</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">_drawContext</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">_fvarDesc</span><span class="p">;</span>

    <span class="n">clearComputeContextAndVertexBuffer</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">clearComputeContextAndVertexBuffer</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="k">delete</span> <span class="n">_cpuComputeContext</span><span class="p">;</span>
    <span class="n">_cpuComputeContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">_cpuPositionBuffer</span><span class="p">;</span>
    <span class="n">_cpuPositionBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="k">delete</span> <span class="n">_cudaComputeContext</span><span class="p">;</span>
    <span class="n">_cudaComputeContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">_cudaPositionBuffer</span><span class="p">;</span>
    <span class="n">_cudaPositionBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="k">delete</span> <span class="n">_clComputeContext</span><span class="p">;</span>
    <span class="n">_clComputeContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">_clPositionBuffer</span><span class="p">;</span>
    <span class="n">_clPositionBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <h4>buildUVList</h4>

<p>Face-varying data expects a list of per-face per-vertex
floats.  This method reads the UVs from the mesh and 
concatenates them into such a list.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">MStatus</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">buildUVList</span><span class="p">(</span> <span class="n">MFnMesh</span><span class="o">&amp;</span> <span class="n">meshFn</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">uvList</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">MStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MS</span><span class="o">::</span><span class="n">kSuccess</span><span class="p">;</span>

    <span class="n">MItMeshPolygon</span> <span class="n">polyIt</span><span class="p">(</span> <span class="n">_meshDagPath</span> <span class="p">);</span>

    <span class="n">MFloatArray</span> <span class="n">uArray</span><span class="p">;</span>
    <span class="n">MFloatArray</span> <span class="n">vArray</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>If user hasn't given us a UV set, use the current one</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">MString</span> <span class="o">*</span><span class="n">uvSetPtr</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">_uvSet</span><span class="p">.</span><span class="n">numChars</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">uvSetNameIsValid</span><span class="p">(</span><span class="n">meshFn</span><span class="p">,</span> <span class="n">_uvSet</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uvSetPtr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_uvSet</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">MGlobal</span><span class="o">::</span><span class="n">displayWarning</span><span class="p">(</span><span class="n">MString</span><span class="p">(</span><span class="s">&quot;OpenSubdivShader:  uvSet </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">+</span><span class="n">_uvSet</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> does not exist.&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">uvSetPtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Pull UVs from Maya mesh</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">status</span> <span class="o">=</span> <span class="n">meshFn</span><span class="p">.</span><span class="n">getUVs</span><span class="p">(</span> <span class="n">uArray</span><span class="p">,</span> <span class="n">vArray</span><span class="p">,</span> <span class="n">uvSetPtr</span> <span class="p">);</span>
    <span class="n">MCHECK_RETURN</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;OpenSubdivShader: Error reading UVs&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">uArray</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vArray</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MGlobal</span><span class="o">::</span><span class="n">displayWarning</span><span class="p">(</span><span class="s">&quot;OpenSubdivShader: Mesh has no UVs&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">MS</span><span class="o">::</span><span class="n">kFailure</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Initalize list of UV values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">uvList</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">uvList</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">meshFn</span><span class="p">.</span><span class="n">numFaceVertices</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span> <span class="p">);</span>
    <span class="kt">int</span> <span class="n">uvListIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>For each face-vertex copy UVs into list, adjusting for renderman orientation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span> <span class="n">polyIt</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span> <span class="o">!</span><span class="n">polyIt</span><span class="p">.</span><span class="n">isDone</span><span class="p">();</span> <span class="n">polyIt</span><span class="p">.</span><span class="n">next</span><span class="p">()</span> <span class="p">)</span> 
    <span class="p">{</span> 
        <span class="kt">int</span>          <span class="n">faceIdx</span>      <span class="o">=</span> <span class="n">polyIt</span><span class="p">.</span><span class="n">index</span><span class="p">();</span> 
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numPolyVerts</span> <span class="o">=</span> <span class="n">polyIt</span><span class="p">.</span><span class="n">polygonVertexCount</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">faceVertIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
                           <span class="n">faceVertIdx</span> <span class="o">&lt;</span> <span class="n">numPolyVerts</span><span class="p">;</span> 
                           <span class="n">faceVertIdx</span><span class="o">++</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">uvIdx</span><span class="p">;</span>
            <span class="n">polyIt</span><span class="p">.</span><span class="n">getUVIndex</span><span class="p">(</span> <span class="n">faceVertIdx</span><span class="p">,</span> <span class="n">uvIdx</span><span class="p">,</span> <span class="n">uvSetPtr</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>convert maya UV orientation to renderman orientation</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">uvList</span><span class="p">[</span> <span class="n">uvListIdx</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">uArray</span><span class="p">[</span> <span class="n">uvIdx</span> <span class="p">];</span>
            <span class="n">uvList</span><span class="p">[</span> <span class="n">uvListIdx</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="n">vArray</span><span class="p">[</span> <span class="n">uvIdx</span> <span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h4>rebuildHbrMeshIfNeeded</h4>

<pre><code> If the topology of the mesh changes, or any attributes that affect
 how the mesh is computed the original HBR needs to be rebuilt
 which will trigger a rebuild of the FAR mesh and subsequent buffers.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">rebuildHbrMeshIfNeeded</span><span class="p">(</span><span class="n">OpenSubdivShader</span> <span class="o">*</span><span class="n">shader</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MS</span><span class="o">::</span><span class="n">kSuccess</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_meshTopoDirty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shader</span><span class="o">-&gt;</span><span class="n">getHbrMeshDirty</span><span class="p">())</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">MFnMesh</span> <span class="n">meshFn</span><span class="p">(</span><span class="n">_meshDagPath</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Cache attribute values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">_level</span>      <span class="o">=</span> <span class="n">shader</span><span class="o">-&gt;</span><span class="n">getLevel</span><span class="p">();</span>
    <span class="n">_kernel</span>     <span class="o">=</span> <span class="n">shader</span><span class="o">-&gt;</span><span class="n">getKernel</span><span class="p">();</span>
    <span class="n">_adaptive</span>   <span class="o">=</span> <span class="n">shader</span><span class="o">-&gt;</span><span class="n">isAdaptive</span><span class="p">();</span>
    <span class="n">_uvSet</span>      <span class="o">=</span> <span class="n">shader</span><span class="o">-&gt;</span><span class="n">getUVSet</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">_level</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">_level</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Get Maya vertex topology and crease data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">MIntArray</span> <span class="n">vertexCount</span><span class="p">;</span>
    <span class="n">MIntArray</span> <span class="n">vertexList</span><span class="p">;</span>
    <span class="n">meshFn</span><span class="p">.</span><span class="n">getVertices</span><span class="p">(</span><span class="n">vertexCount</span><span class="p">,</span> <span class="n">vertexList</span><span class="p">);</span>

    <span class="n">MUintArray</span> <span class="n">edgeIds</span><span class="p">;</span>
    <span class="n">MDoubleArray</span> <span class="n">edgeCreaseData</span><span class="p">;</span>
    <span class="n">meshFn</span><span class="p">.</span><span class="n">getCreaseEdges</span><span class="p">(</span><span class="n">edgeIds</span><span class="p">,</span> <span class="n">edgeCreaseData</span><span class="p">);</span>

    <span class="n">MUintArray</span> <span class="n">vtxIds</span><span class="p">;</span>
    <span class="n">MDoubleArray</span> <span class="n">vtxCreaseData</span><span class="p">;</span>
    <span class="n">meshFn</span><span class="p">.</span><span class="n">getCreaseVertices</span><span class="p">(</span><span class="n">vtxIds</span><span class="p">,</span> <span class="n">vtxCreaseData</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vertexCount</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Copy Maya vectors into std::vectors</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">numIndices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vertexCount</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">vertexCount</span><span class="p">[</span><span class="n">vertexCount</span><span class="p">.</span><span class="n">length</span><span class="p">()]);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">faceIndices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vertexList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">vertexList</span><span class="p">[</span><span class="n">vertexList</span><span class="p">.</span><span class="n">length</span><span class="p">()]);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vtxCreaseIndices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtxIds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">vtxIds</span><span class="p">[</span><span class="n">vtxIds</span><span class="p">.</span><span class="n">length</span><span class="p">()]);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">vtxCreases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtxCreaseData</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">vtxCreaseData</span><span class="p">[</span><span class="n">vtxCreaseData</span><span class="p">.</span><span class="n">length</span><span class="p">()]);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">edgeCreases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edgeCreaseData</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">edgeCreaseData</span><span class="p">[</span><span class="n">edgeCreaseData</span><span class="p">.</span><span class="n">length</span><span class="p">()]);</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Edge crease index is stored as pairs of vertex ids</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">int</span> <span class="n">nEdgeIds</span> <span class="o">=</span> <span class="n">edgeIds</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">edgeCreaseIndices</span><span class="p">;</span>
    <span class="n">edgeCreaseIndices</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nEdgeIds</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nEdgeIds</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">int2</span> <span class="n">vertices</span><span class="p">;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">meshFn</span><span class="p">.</span><span class="n">getEdgeVertices</span><span class="p">(</span><span class="n">edgeIds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vertices</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">error</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">MERROR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;OpenSubdivShader: Can&#39;t get edge vertices&quot;</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">edgeCreaseIndices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">edgeCreaseIndices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Convert attribute enums to HBR enums (this is why the enums need to match)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">SchemeType</span> <span class="n">hbrScheme</span> <span class="o">=</span> <span class="p">(</span><span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">SchemeType</span><span class="p">)</span> <span class="n">shader</span><span class="o">-&gt;</span><span class="n">getScheme</span><span class="p">();</span>
    <span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span> <span class="n">hbrInterpBoundary</span> <span class="o">=</span> 
            <span class="p">(</span><span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span><span class="p">)</span> <span class="n">shader</span><span class="o">-&gt;</span><span class="n">getInterpolateBoundary</span><span class="p">();</span>
    <span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span> <span class="n">hbrInterpUVBoundary</span> <span class="o">=</span> 
            <span class="p">(</span><span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span><span class="p">)</span> <span class="n">shader</span><span class="o">-&gt;</span><span class="n">getInterpolateUVBoundary</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Clear any existing face-varying descriptor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">_fvarDesc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="n">_fvarDesc</span><span class="p">;</span>
        <span class="n">_fvarDesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Read UV data from maya and build per-face per-vert list of UVs for HBR face-varying data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="kt">float</span> <span class="o">&gt;</span> <span class="n">uvList</span><span class="p">;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">buildUVList</span><span class="p">(</span> <span class="n">meshFn</span><span class="p">,</span> <span class="n">uvList</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">status</span><span class="p">.</span><span class="n">error</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Create face-varying data descriptor.  The memory required for indices
and widths needs to stay alive as the HBR library only takes in the
pointers and assumes the client will maintain the memory so keep _fvarDesc
around as long as _hbrmesh is around.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kt">int</span> <span class="n">fvarIndices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
        <span class="kt">int</span> <span class="n">fvarWidths</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
        <span class="n">_fvarDesc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FVarDataDesc</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fvarIndices</span><span class="p">,</span> <span class="n">fvarWidths</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hbrInterpUVBoundary</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_fvarDesc</span> <span class="o">&amp;&amp;</span> <span class="n">hbrScheme</span> <span class="o">!=</span> <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">kCatmark</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MGlobal</span><span class="o">::</span><span class="n">displayWarning</span><span class="p">(</span><span class="s">&quot;Face-varying not yet supported for Loop/Bilinear, using Catmull-Clark&quot;</span><span class="p">);</span>
        <span class="n">hbrScheme</span> <span class="o">=</span> <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">kCatmark</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Convert Maya mesh to internal HBR representation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">_hbrmesh</span> <span class="o">=</span> <span class="n">ConvertToHBR</span><span class="p">(</span><span class="n">meshFn</span><span class="p">.</span><span class="n">numVertices</span><span class="p">(),</span> <span class="n">numIndices</span><span class="p">,</span> <span class="n">faceIndices</span><span class="p">,</span>
                            <span class="n">vtxCreaseIndices</span><span class="p">,</span> <span class="n">vtxCreases</span><span class="p">,</span>
                            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(),</span>
                            <span class="n">edgeCreaseIndices</span><span class="p">,</span> <span class="n">edgeCreases</span><span class="p">,</span>
                            <span class="n">hbrInterpBoundary</span><span class="p">,</span> 
                            <span class="n">hbrScheme</span><span class="p">,</span>
                            <span class="kc">false</span><span class="p">,</span>                      <span class="c1">// no ptex</span>
                            <span class="n">_fvarDesc</span><span class="p">,</span> 
                            <span class="n">_fvarDesc</span><span class="o">?&amp;</span><span class="nl">uvList:</span><span class="nb">NULL</span><span class="p">);</span>    <span class="c1">// yes fvar (if have UVs)</span>

    <span class="cm">/* note: GL function can&#39;t be used in prepareForDraw API. */</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Set dirty flag for FAR mesh factory to regenerate</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">_needsInitializeMesh</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Mesh topology data is up to date</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">_meshTopoDirty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="n">shader</span><span class="o">-&gt;</span><span class="n">setHbrMeshDirty</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <h4>initializeMesh</h4>

<p><code>dyu - some juicy details about mesh factory and what a compute context is</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">initializeMesh</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_hbrmesh</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Create FAR mesh</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">FarMeshFactory</span><span class="o">&lt;</span><span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdVertex</span><span class="o">&gt;</span>
        <span class="n">meshFactory</span><span class="p">(</span><span class="n">_hbrmesh</span><span class="p">,</span> <span class="n">_level</span><span class="p">,</span> <span class="n">_adaptive</span><span class="p">);</span>

    <span class="n">_farmesh</span> <span class="o">=</span> <span class="n">meshFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span>  <span class="cm">/* ptex coords */</span>
                                  <span class="kc">true</span><span class="p">);</span>  <span class="cm">/* fvar data */</span>

    <span class="k">delete</span> <span class="n">_hbrmesh</span><span class="p">;</span>
    <span class="n">_hbrmesh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">numTotalVertices</span> <span class="o">=</span> <span class="n">_farmesh</span><span class="o">-&gt;</span><span class="n">GetNumVertices</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Create context and vertex buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">clearComputeContextAndVertexBuffer</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCPU</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_cpuComputeContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCpuComputeContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">);</span>
        <span class="n">_cpuPositionBuffer</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCpuGLVertexBuffer</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">numTotalVertices</span><span class="p">);</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_OPENMP</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kOPENMP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_cpuComputeContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCpuComputeContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">);</span>
        <span class="n">_cpuPositionBuffer</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCpuGLVertexBuffer</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">numTotalVertices</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCUDA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_cudaComputeContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCudaComputeContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">);</span>
        <span class="n">_cudaPositionBuffer</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCudaGLVertexBuffer</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">numTotalVertices</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_clComputeContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCLComputeContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">,</span> <span class="n">g_clContext</span><span class="p">);</span>
        <span class="n">_clPositionBuffer</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdCLGLVertexBuffer</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">numTotalVertices</span><span class="p">,</span>
                                                                    <span class="n">g_clContext</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>

    <span class="n">_needsInitializeMesh</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Get geometry from maya mesh</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">MFnMesh</span> <span class="n">meshFn</span><span class="p">(</span><span class="n">_meshDagPath</span><span class="p">);</span>
    <span class="n">meshFn</span><span class="p">.</span><span class="n">getPoints</span><span class="p">(</span><span class="n">_pointArray</span><span class="p">);</span>

    <span class="n">_needsUpdate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <h4>createKernelDrawContext</h4>

<p><code>dyu - more juicy details</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">createKernelDrawContext</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="k">delete</span> <span class="n">_drawContext</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCPU</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_drawContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">,</span>
                                                            <span class="n">_cpuPositionBuffer</span><span class="p">,</span>
                                                            <span class="kc">false</span><span class="p">,</span>  <span class="c1">// ptex coords?</span>
                                                            <span class="kc">true</span><span class="p">);</span>  <span class="c1">// fvar data?</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_OPENMP</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kOPENMP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_drawContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">,</span>
                                                            <span class="n">_cpuPositionBuffer</span><span class="p">,</span>
                                                            <span class="kc">false</span><span class="p">,</span>  <span class="kc">true</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCUDA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_drawContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">,</span>
                                                            <span class="n">_cudaPositionBuffer</span><span class="p">,</span>
                                                            <span class="kc">false</span><span class="p">,</span>  <span class="kc">true</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_drawContext</span> <span class="o">=</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdGLDrawContext</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">_farmesh</span><span class="p">,</span>
                                                            <span class="n">_clPositionBuffer</span><span class="p">,</span>
                                                            <span class="kc">false</span><span class="p">,</span>  <span class="kc">true</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <h4>prepare</h4>

<p>If HBR mesh has been rebuilt the mesh factory and draw context
 also need to be rebuilt.</p>

<p><code>dyu - it seems like this could be merged with rebuildHBR</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">prepare</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_needsInitializeMesh</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">initializeMesh</span><span class="p">();</span>
        <span class="n">createKernelDrawContext</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <h4>updateGeometry</h4>

<p>Refine the geometry.</p>

<p><code>dyu - probably need more detail... do they need to know about the bind/subdata copy?</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kt">void</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">updateGeometry</span><span class="p">(</span><span class="k">const</span> <span class="n">MHWRender</span><span class="o">::</span><span class="n">MVertexBuffer</span> <span class="o">*</span><span class="n">points</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">nCoarsePoints</span> <span class="o">=</span> <span class="n">_pointArray</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>

    <span class="n">GLuint</span> <span class="n">mayaPositionVBO</span> <span class="o">=</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">GLuint</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">points</span><span class="o">-&gt;</span><span class="n">resourceHandle</span><span class="p">());</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">nCoarsePoints</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCPU</span> <span class="o">||</span> <span class="n">_kernel</span> <span class="o">==</span> <span class="n">kOPENMP</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">d_pos</span> <span class="o">=</span> <span class="n">_cpuPositionBuffer</span><span class="o">-&gt;</span><span class="n">BindCpuBuffer</span><span class="p">();</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_ARRAY_BUFFER</span><span class="p">,</span> <span class="n">mayaPositionVBO</span><span class="p">);</span>
        <span class="n">glGetBufferSubData</span><span class="p">(</span><span class="n">GL_ARRAY_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">d_pos</span><span class="p">);</span>
        <span class="n">g_cpuComputeController</span><span class="o">-&gt;</span><span class="n">Refine</span><span class="p">(</span><span class="n">_cpuComputeContext</span><span class="p">,</span> <span class="n">_cpuPositionBuffer</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_ARRAY_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCUDA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_READ_BUFFER</span><span class="p">,</span> <span class="n">mayaPositionVBO</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_WRITE_BUFFER</span><span class="p">,</span> <span class="n">_cudaPositionBuffer</span><span class="o">-&gt;</span><span class="n">BindVBO</span><span class="p">());</span>
        <span class="n">glCopyBufferSubData</span><span class="p">(</span><span class="n">GL_COPY_READ_BUFFER</span><span class="p">,</span> <span class="n">GL_COPY_WRITE_BUFFER</span><span class="p">,</span>
                            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
        <span class="n">g_cudaComputeController</span><span class="o">-&gt;</span><span class="n">Refine</span><span class="p">(</span><span class="n">_cudaComputeContext</span><span class="p">,</span> <span class="n">_cudaPositionBuffer</span><span class="p">);</span>

        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_READ_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_WRITE_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_READ_BUFFER</span><span class="p">,</span> <span class="n">mayaPositionVBO</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_WRITE_BUFFER</span><span class="p">,</span> <span class="n">_clPositionBuffer</span><span class="o">-&gt;</span><span class="n">BindVBO</span><span class="p">());</span>
        <span class="n">glCopyBufferSubData</span><span class="p">(</span><span class="n">GL_COPY_READ_BUFFER</span><span class="p">,</span> <span class="n">GL_COPY_WRITE_BUFFER</span><span class="p">,</span>
                            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
        <span class="n">g_clComputeController</span><span class="o">-&gt;</span><span class="n">Refine</span><span class="p">(</span><span class="n">_clComputeContext</span><span class="p">,</span> <span class="n">_clPositionBuffer</span><span class="p">);</span>

        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_READ_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">glBindBuffer</span><span class="p">(</span><span class="n">GL_COPY_WRITE_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>

    <span class="n">_needsUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <h4>bindPositionVBO</h4>

<p>Wrapper to bind position the correct vertex buffer
according to the current compute kernel</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">GLuint</span>
<span class="n">OsdMeshData</span><span class="o">::</span><span class="n">bindPositionVBO</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCPU</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_cpuPositionBuffer</span><span class="o">-&gt;</span><span class="n">BindVBO</span><span class="p">();</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_OPENMP</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kOPENMP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_cpuPositionBuffer</span><span class="o">-&gt;</span><span class="n">BindVBO</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_CUDA</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCUDA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_cudaPositionBuffer</span><span class="o">-&gt;</span><span class="n">BindVBO</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef OPENSUBDIV_HAS_OPENCL</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_kernel</span> <span class="o">==</span> <span class="n">kCL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_clPositionBuffer</span><span class="o">-&gt;</span><span class="n">BindVBO</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>hbrUtil.h</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <h4>Face-varying data descriptor</h4>

<pre><code> Wrapper for basic information needed to request
 face-varying data allocation from HBR
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">FVarDataDesc</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Must be instantiated with descriptor information</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">FVarDataDesc</span><span class="p">(</span>      <span class="kt">int</span>   <span class="n">count</span><span class="p">,</span> 
                  <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">indices</span><span class="p">,</span>   <span class="c1">// start index for each face-varying variable</span>
                  <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">widths</span><span class="p">,</span>    <span class="c1">// width for each face-varying variable</span>
                        <span class="kt">int</span>  <span class="n">width</span><span class="p">,</span>
                        <span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span> 
                             <span class="n">boundary</span><span class="o">=</span><span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">k_InterpolateBoundaryNone</span>
                        <span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">_fvarCount</span>      <span class="o">=</span> <span class="n">count</span><span class="p">;</span> 
        <span class="n">_totalfvarWidth</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
        <span class="n">_fvarIndices</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">indices</span><span class="p">,</span> <span class="n">indices</span><span class="o">+</span><span class="n">count</span> <span class="p">);</span>
        <span class="n">_fvarWidths</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">widths</span><span class="p">,</span> <span class="n">widths</span><span class="o">+</span><span class="n">count</span> <span class="p">);</span>
        <span class="n">_interpBoundary</span> <span class="o">=</span> <span class="n">boundary</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">~</span><span class="n">FVarDataDesc</span><span class="p">()</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <h5>Accessors</h5>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kt">int</span>  <span class="n">getCount</span><span class="p">()</span> <span class="k">const</span>          <span class="p">{</span> <span class="k">return</span> <span class="n">_fvarCount</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">getIndices</span><span class="p">()</span> <span class="k">const</span>        <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">_fvarIndices</span><span class="p">.</span><span class="n">front</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">getWidths</span><span class="p">()</span> <span class="k">const</span>         <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">_fvarWidths</span><span class="p">.</span><span class="n">front</span><span class="p">();</span> <span class="p">}</span>
          <span class="kt">int</span>  <span class="n">getTotalWidth</span><span class="p">()</span> <span class="k">const</span>     <span class="p">{</span> <span class="k">return</span> <span class="n">_totalfvarWidth</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span> 
               <span class="n">getInterpBoundary</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_interpBoundary</span><span class="p">;</span> <span class="p">}</span>

<span class="k">private</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <h5>Face-varying data parameters</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">int</span>  <span class="n">_fvarCount</span><span class="p">;</span>                <span class="c1">// Number of facevarying datums</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">_fvarIndices</span><span class="p">;</span>  <span class="c1">// Start indices of the facevarying data </span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">_fvarWidths</span><span class="p">;</span>   <span class="c1">// Individual widths of facevarying data</span>
    <span class="kt">int</span>  <span class="n">_totalfvarWidth</span><span class="p">;</span>           <span class="c1">// Total widths of the facevarying data</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <h5>Boundary interpolation</h5>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span> <span class="n">_interpBoundary</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="n">OsdHbrMesh</span> <span class="o">*</span> <span class="n">ConvertToHBR</span><span class="p">(</span> <span class="p">...</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <h2>--------------------------------------------------------------------------------------</h2>

<h3>hbrUtil.cpp</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <h4>ConvertToHBR</h4>

<pre><code> Take Maya mesh topology input and build an HBR mesh.  Optional
 input parameters direct the method to create Ptex texture
 coordinates or to copy given face-varying data to the 
 HBR faces as they are created.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">OsdHbrMesh</span> <span class="o">*</span> 
<span class="n">ConvertToHBR</span><span class="p">(</span> <span class="kt">int</span> <span class="n">nVertices</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>   <span class="k">const</span> <span class="o">&amp;</span> <span class="n">faceVertCounts</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>   <span class="k">const</span> <span class="o">&amp;</span> <span class="n">faceIndices</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>   <span class="k">const</span> <span class="o">&amp;</span> <span class="n">vtxCreaseIndices</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">vtxCreases</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>   <span class="k">const</span> <span class="o">&amp;</span> <span class="n">edgeCrease1Indices</span><span class="p">,</span>  <span class="c1">// face index, local edge index</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">edgeCreases1</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>   <span class="k">const</span> <span class="o">&amp;</span> <span class="n">edgeCrease2Indices</span><span class="p">,</span>  <span class="c1">// 2 vertex indices (Maya friendly)</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">edgeCreases2</span><span class="p">,</span>
              <span class="n">OsdHbrMesh</span><span class="o">::</span><span class="n">InterpolateBoundaryMethod</span> <span class="n">interpBoundary</span><span class="p">,</span>
              <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">SchemeType</span> <span class="n">scheme</span><span class="p">,</span>
              <span class="kt">bool</span> <span class="n">usingPtex</span><span class="p">,</span>                       <span class="c1">// defaults to false</span>
              <span class="n">FVarDataDesc</span> <span class="k">const</span> <span class="o">*</span> <span class="n">fvarDesc</span><span class="p">,</span>        <span class="c1">// defaults to NULL</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">*</span> <span class="n">fvarData</span>   <span class="c1">// defaults to NULL</span>
            <span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">HbrBilinearSubdivision</span><span class="o">&lt;</span><span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdVertex</span><span class="o">&gt;</span> <span class="n">_bilinear</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">HbrLoopSubdivision</span><span class="o">&lt;</span><span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdVertex</span><span class="o">&gt;</span> <span class="n">_loop</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">HbrCatmarkSubdivision</span><span class="o">&lt;</span><span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdVertex</span><span class="o">&gt;</span> <span class="n">_catmark</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Build HBR mesh with/without face varying data, according to input data.
If a face-varying descriptor is passed in its memory needs to stay 
alive as long as this hbrMesh is alive (for indices and widths arrays). </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">OsdHbrMesh</span> <span class="o">*</span><span class="n">hbrMesh</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">fvarDesc</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">kCatmark</span><span class="p">)</span>
            <span class="n">hbrMesh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OsdHbrMesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_catmark</span><span class="p">,</span>  <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getCount</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getIndices</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getWidths</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getTotalWidth</span><span class="p">());</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">kLoop</span><span class="p">)</span>
            <span class="n">hbrMesh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OsdHbrMesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_loop</span><span class="p">,</span>     <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getCount</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getIndices</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getWidths</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getTotalWidth</span><span class="p">());</span>
        <span class="k">else</span> 
            <span class="n">hbrMesh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OsdHbrMesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_bilinear</span><span class="p">,</span> <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getCount</span><span class="p">(),</span>
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getIndices</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getWidths</span><span class="p">(),</span> 
                                                 <span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getTotalWidth</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">kCatmark</span><span class="p">)</span>
            <span class="n">hbrMesh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OsdHbrMesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_catmark</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">kLoop</span><span class="p">)</span>
            <span class="n">hbrMesh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OsdHbrMesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_loop</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">hbrMesh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OsdHbrMesh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_bilinear</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Create empty verts: actual vertices initialized in UpdatePoints();</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">OpenSubdiv</span><span class="o">::</span><span class="n">OsdVertex</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nVertices</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">NewVertex</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vIndex</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nFaces</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">faceVertCounts</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">fvcOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// face-vertex count offset</span>
    <span class="kt">int</span> <span class="n">ptxIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Collect vertex indices for each face and create HBR face</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fi</span> <span class="o">&lt;</span> <span class="n">nFaces</span><span class="p">;</span> <span class="o">++</span><span class="n">fi</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">nFaceVerts</span> <span class="o">=</span> <span class="n">faceVertCounts</span><span class="p">[</span><span class="n">fi</span><span class="p">];</span>
        <span class="n">vIndex</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nFaceVerts</span><span class="p">);</span>

        <span class="kt">bool</span> <span class="n">valid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fvi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fvi</span> <span class="o">&lt;</span> <span class="n">nFaceVerts</span><span class="p">;</span> <span class="o">++</span><span class="n">fvi</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="n">vIndex</span><span class="p">[</span><span class="n">fvi</span><span class="p">]</span> <span class="o">=</span> <span class="n">faceIndices</span><span class="p">[</span><span class="n">fvi</span> <span class="o">+</span> <span class="n">fvcOffset</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">vNextIndex</span> <span class="o">=</span> <span class="n">faceIndices</span><span class="p">[(</span><span class="n">fvi</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nFaceVerts</span> <span class="o">+</span> <span class="n">fvcOffset</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Check for non-manifold face</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">OsdHbrVertex</span> <span class="o">*</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">GetVertex</span><span class="p">(</span><span class="n">vIndex</span><span class="p">[</span><span class="n">fvi</span><span class="p">]);</span>
            <span class="n">OsdHbrVertex</span> <span class="o">*</span> <span class="n">destination</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">GetVertex</span><span class="p">(</span><span class="n">vNextIndex</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">origin</span> <span class="o">||</span> <span class="o">!</span><span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;ERROR : An edge was specified that connected a nonexistent vertex&quot;</span><span class="p">);</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;ERROR : An edge was specified that connected a vertex to itself&quot;</span><span class="p">);</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">OsdHbrHalfedge</span> <span class="o">*</span> <span class="n">opposite</span> <span class="o">=</span> <span class="n">destination</span><span class="o">-&gt;</span><span class="n">GetEdge</span><span class="p">(</span><span class="n">origin</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opposite</span> <span class="o">&amp;&amp;</span> <span class="n">opposite</span><span class="o">-&gt;</span><span class="n">GetOpposite</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;ERROR : A non-manifold edge incident to more than 2 faces was found&quot;</span><span class="p">);</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">origin</span><span class="o">-&gt;</span><span class="n">GetEdge</span><span class="p">(</span><span class="n">destination</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;ERROR : An edge connecting two vertices was specified more than once. &quot;</span>
                          <span class="s">&quot;It&#39;s likely that an incident face was flipped&quot;</span><span class="p">);</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">valid</span> <span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="n">HbrMeshUtil</span><span class="o">::</span><span class="n">kLoop</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>For Loop subdivision, triangulate from vertex indices</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kt">int</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
                <span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vIndex</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fvi</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">fvi</span> <span class="o">&lt;</span> <span class="n">nFaceVerts</span><span class="p">;</span> <span class="o">++</span><span class="n">fvi</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vIndex</span><span class="p">[</span><span class="n">fvi</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
                    <span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vIndex</span><span class="p">[</span><span class="n">fvi</span><span class="p">];</span>
                    <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">NewFace</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">triangle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="cm">/* ptex not fully implemented for loop, yet */</span>
                <span class="cm">/* fvar not fully implemented for loop, yet */</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>For Catmull-Clark subdivision, create a quad face from vertices</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="cm">/* bilinear subdivision not fully implemented */</span>
                <span class="n">OsdHbrFace</span> <span class="o">*</span><span class="n">face</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">NewFace</span><span class="p">(</span><span class="n">nFaceVerts</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">vIndex</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">usingPtex</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Ptex textures will be used, set up ptex coordinates</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="n">face</span><span class="o">-&gt;</span><span class="n">SetPtexIndex</span><span class="p">(</span><span class="n">ptxIdx</span><span class="p">);</span>
                    <span class="n">ptxIdx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">nFaceVerts</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">nFaceVerts</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">fvarData</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Face-varying data has been passed in, get pointer to data</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="kt">int</span> <span class="n">fvarWidth</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">GetTotalFVarWidth</span><span class="p">();</span>
                    <span class="k">const</span> <span class="kt">float</span> <span class="o">*</span><span class="n">faceData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">fvarData</span><span class="p">)[</span> <span class="n">fvcOffset</span><span class="o">*</span><span class="n">fvarWidth</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>For each face vertex copy fvar data into hbr mesh</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">fvi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">fvi</span><span class="o">&lt;</span><span class="n">nFaceVerts</span><span class="p">;</span> <span class="o">++</span><span class="n">fvi</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">OsdHbrVertex</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">GetVertex</span><span class="p">(</span> <span class="n">vIndex</span><span class="p">[</span><span class="n">fvi</span><span class="p">]</span> <span class="p">);</span>
                        <span class="n">OsdHbrFVarData</span><span class="o">&amp;</span> <span class="n">fvarData</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">GetFVarData</span><span class="p">(</span><span class="n">face</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="n">fvarData</span><span class="p">.</span><span class="n">IsInitialized</span><span class="p">()</span> <span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">fvarData</span><span class="p">.</span><span class="n">SetAllData</span><span class="p">(</span> <span class="n">fvarWidth</span><span class="p">,</span> <span class="n">faceData</span> <span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fvarData</span><span class="p">.</span><span class="n">CompareAll</span><span class="p">(</span><span class="n">fvarWidth</span><span class="p">,</span> <span class="n">faceData</span><span class="p">))</span>
                        <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>If data exists for this face vertex, but is different
(e.g. we're on a UV seam) create another fvar datum</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="n">OsdHbrFVarData</span><span class="o">&amp;</span> <span class="n">fvarData</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">NewFVarData</span><span class="p">(</span><span class="n">face</span><span class="p">);</span>
                            <span class="n">fvarData</span><span class="p">.</span><span class="n">SetAllData</span><span class="p">(</span> <span class="n">fvarWidth</span><span class="p">,</span> <span class="n">faceData</span> <span class="p">);</span>
                        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Advance pointer to next set of face-varying data</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="n">faceData</span> <span class="o">+=</span> <span class="n">fvarWidth</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;Face %d will be ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fi</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">fvcOffset</span> <span class="o">+=</span> <span class="n">nFaceVerts</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Assign boundary interpolation methods</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">SetInterpolateBoundaryMethod</span><span class="p">(</span><span class="n">interpBoundary</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">fvarDesc</span> <span class="p">)</span> 
        <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">SetFVarInterpolateBoundaryMethod</span><span class="p">(</span><span class="n">fvarDesc</span><span class="o">-&gt;</span><span class="n">getInterpBoundary</span><span class="p">());</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Set edge crease in two different indexing way</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">size_t</span> <span class="n">nEdgeCreases</span> <span class="o">=</span> <span class="n">edgeCreases1</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nEdgeCreases</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">edgeCreases1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="n">OsdHbrHalfedge</span> <span class="o">*</span> <span class="n">e</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span>
            <span class="n">GetFace</span><span class="p">(</span><span class="n">edgeCrease1Indices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span><span class="o">-&gt;</span>
            <span class="n">GetEdge</span><span class="p">(</span><span class="n">edgeCrease1Indices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;Can&#39;t find edge (face %d edge %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                      <span class="n">edgeCrease1Indices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span> <span class="n">edgeCrease1Indices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">SetSharpness</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">edgeCreases1</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="n">nEdgeCreases</span> <span class="o">=</span> <span class="n">edgeCreases2</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nEdgeCreases</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">edgeCreases2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="n">OsdHbrVertex</span> <span class="o">*</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">GetVertex</span><span class="p">(</span><span class="n">edgeCrease2Indices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]);</span>
        <span class="n">OsdHbrVertex</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">GetVertex</span><span class="p">(</span><span class="n">edgeCrease2Indices</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">OsdHbrHalfedge</span> <span class="o">*</span> <span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&amp;&amp;</span> <span class="n">v1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">v0</span><span class="o">-&gt;</span><span class="n">GetEdge</span><span class="p">(</span><span class="n">v1</span><span class="p">)))</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">v1</span><span class="o">-&gt;</span><span class="n">GetEdge</span><span class="p">(</span><span class="n">v0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;ERROR can&#39;t find edge&quot;</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">SetSharpness</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">edgeCreases2</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Set corner</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">{</span>
        <span class="n">size_t</span> <span class="n">nVertexCreases</span> <span class="o">=</span> <span class="n">vtxCreases</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nVertexCreases</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">vtxCreases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="n">OsdHbrVertex</span> <span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">GetVertex</span><span class="p">(</span><span class="n">vtxCreaseIndices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">OSD_ERROR</span><span class="p">(</span><span class="s">&quot;Can&#39;t find vertex %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vtxCreaseIndices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">v</span><span class="o">-&gt;</span><span class="n">SetSharpness</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vtxCreases</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Call finish to complete build of HBR mesh</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">hbrMesh</span><span class="o">-&gt;</span><span class="n">Finish</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">hbrMesh</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p><code>dyu:  do we need to have one of these dudes for shader.glsl?</code></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 